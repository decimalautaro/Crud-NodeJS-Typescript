<!DOCTYPE html>
<html lang="es">

<%- include('../template/cabecera') %>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="./profile"><img src="img/icon.png" alt="Node.js icon" class="nav-icon"></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <%- include ('../template/ul') %>
            <form class="d-flex" action="./search-servicio" method="GET">
              <input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Buscar" name="search">
              <button class="btn secondary-btn" type="submit">Buscar</button>
            </form>
            <a href="/logout" class="btn btn-secondary ms-4">Cerrar sesion</a>
        </div>
      </div>
    </nav>
    <br>
    <div class="row container centered" width="100vw">
      <div class="position-absolute">
        <%- include ('../message/message') %>
      </div>
      <div class="text-center">
        <h2>Tabla de servicios</h2>
      </div>
      <br>
      <br>
      <br>
      <div class="table-wrapper-scroll-y my-custom-scrollbar">
        <table id="tablaServicios" class="table table-hover">
          <thead>
            <th scope="col">Planes</th>
            <th scope="col">Tipo de servicio</th>
            <th scope="col">Precio</th>
            <th scope="col">Creacion</th>
            <th scope="col">Actualizacion</th>
            <th scope="col">Acciones</th>
          </thead>
          <tbody>
            <% servicio.forEach(function(servicio) { %>
              <tr>
                <td>
                  <%= servicio.planes %>
                </td>
                <td>
                  <%= servicio.tipoServicio %>
                </td>
                <td>
                  <%= servicio.precio %>
                </td>

                <td>
                  <%= servicio.created_at.toLocaleDateString() %>
                    <%= servicio.created_at.toLocaleTimeString() %>
                </td>
                <td>
                  <%= servicio.updated_at.toLocaleDateString() %>
                    <%= servicio.updated_at.toLocaleTimeString() %>
                </td>
                <td>
                  <div class="row">
                    <div class="row">
                      <form action="./servicio-edit" method="GET">
                        <input type="hidden" name="id" value="<%= servicio.id %>">
                        <button type="submit" class="btn edit-btn"><i class="bi bi-pencil"></i></button>
                      </form>
                    </div>
                    <div class="row"></div>
                    <div class="row">
                      <form action="./delete-servicio" onclick='confirm("¿Esta seguro que desea eliminar el servicio?")'
                        method="POST">
                        <input type="hidden" name="id" value="<%= servicio.id %>">
                        <button type="submit" class="btn delete-btn"><i class="bi bi-trash"></i></button>
                      </form>
                    </div>
                  </div>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
      </div>
      <br>
      <br>
      <div class="float-start">
        <a href="./add-servicio" class="btn primary-btn">Agregar servicio</a>
        <a href="#" class="btn delete-btn" onclick="download_table_as_csv('tablaServicios');">Descargar en CSV</a>
      </div>
    </div>
    <%- include('../template/footer') %>
      <script>
        function download_table_as_csv(table_id, separator = ',') {
          // Seleccionar filas
          var rows = document.querySelectorAll('table#' + table_id + ' tr');
          // Construcción de csv
          var csv = [];
          for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll('td, th');
            for (var j = 0; j < cols.length; j++) {
              // Limpiar texto interno para eliminar varios espacios y saltos de línea (romper csv)
              var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
              // Escape double-quote with double-double-quote 
              data = data.replace(/"/g, '""');
              // Push escaped string
              row.push('"' + data + '"');
            }
            csv.push(row.join(separator));
          }
          var csv_string = csv.join('\n');
          // Descarga
          var filename = 'Servicios' + table_id + '_' + new Date().toLocaleDateString() + '.csv';
          var link = document.createElement('a');
          link.style.display = 'none';
          link.setAttribute('target', '_blank');
          link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
          link.setAttribute('download', filename);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      </script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
  </body>

</html>